{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block main_container_class %}container-fluid{% endblock %}

{% block head_extra %}
    <!-- 인증 토큰과 CSRF 토큰을 전역 변수로 정의 -->
    <script>
        // 인증 토큰과 CSRF 토큰을 전역변수로 정의
        window.ADMIN_TOKEN = "{{ session.get('admin_token', '') }}";
        window.CSRF_TOKEN = "{{ csrf_token() }}";
        console.log('토큰 상태:', window.ADMIN_TOKEN ? '토큰 있음' : '토큰 없음');
        console.log('CSRF 토큰 상태:', window.CSRF_TOKEN ? 'CSRF 토큰 있음' : 'CSRF 토큰 없음');
    </script>
    
    <!-- CKEditor 5 - 코드 블록을 포함한 더 많은 기능을 가진 빌드 사용 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/super-build/ckeditor.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/super-build/translations/ko.js"></script>
    
    <!-- 마크다운 변환을 위한 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- 코드 블록 하이라이팅을 위한 highlight.js 추가 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid 다이어그램 지원을 위한 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- 이미지 레이아웃 스타일 추가 -->
    <style>
        /* 이미지 스타일 - 왼쪽 정렬 */
        .image-style-align-left {
            float: left;
            margin-right: 20px;
        }
        
        /* 이미지 스타일 - 오른쪽 정렬 */
        .image-style-align-right {
            float: right;
            margin-left: 20px;
        }
        
        /* 이미지 스타일 - 가운데 정렬 */
        .image-style-align-center {
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
        
        /* 이미지 캡션 스타일 */
        .image figcaption {
            text-align: center;
            font-style: italic;
            font-size: 0.9em;
            color: #666;
        }
    </style>
    
    <!-- CKEditor 이미지 업로드 어댑터 - Classic 빌드용 -->
    <script>
        // 커스텀 업로드 어댑터 클래스
        class MyUploadAdapter {
            constructor(loader) {
                // CKEditor 5 파일 로더 인스턴스
                this.loader = loader;
            }

            // 업로드 시작
            upload() {
                return this.loader.file
                    .then(file => {
                        return new Promise((resolve, reject) => {
                            const data = new FormData();
                            data.append('file', file);
                            
                            // CSRF 토큰 추가
                            if (window.CSRF_TOKEN) {
                                data.append('csrf_token', window.CSRF_TOKEN);
                                console.log('CSRF 토큰이 요청에 추가됨');
                            }

                            // XMLHttpRequest 사용
                            const xhr = new XMLHttpRequest();
                            xhr.open('POST', '{{ url_for("admin.upload_editor_image") }}');
                            
                            // 인증 토큰 추가
                            if (window.ADMIN_TOKEN) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + window.ADMIN_TOKEN);
                                console.log('인증 토큰 전송 완료');
                            } else {
                                console.error('인증 토큰이 없습니다.');
                                reject('인증 토큰이 없습니다. 로그아웃 되었을 수 있으니 다시 로그인해주세요.');
                                return;
                            }
                            
                            // 요청 완료시 처리
                            xhr.onload = () => {
                                console.log('서버 응답:', xhr.status, xhr.responseText);
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    try {
                                        const response = JSON.parse(xhr.responseText);
                                        // 성공적으로 이미지 URL을 받으면 resolve
                                        if (response && response.location) {
                                            resolve({ default: response.location });
                                        } else {
                                            reject('유효한 이미지 URL이 없습니다.');
                                        }
                                    } catch (e) {
                                        reject('서버 응답을 처리하는 중 오류 발생: ' + e.message);
                                    }
                                } else {
                                    reject('업로드 실패. 서버 상태: ' + xhr.status + ', 응답: ' + xhr.responseText);
                                }
                            };
                            
                            // 오류 처리
                            xhr.onerror = () => {
                                reject('네트워크 오류로 업로드 실패');
                            };
                            
                            // 업로드 진행상황 모니터링
                            xhr.upload.onprogress = evt => {
                                if (evt.lengthComputable) {
                                    this.loader.uploadTotal = evt.total;
                                    this.loader.uploaded = evt.loaded;
                                }
                            };
                            
                            // 요청 전송
                            xhr.send(data);
                        });
                    });
            }

            // 업로드 취소
            abort() {
                // 취소 로직 구현 (필요시)
            }
        }

        // 업로드 어댑터 플러그인 함수
        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new MyUploadAdapter(loader);
            };
        }
    </script>
    <style>
        /* Decoupled Document 에디터 스타일 */
        .document-editor__toolbar {
            background: #f6f6f6;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 8px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #editor {
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            min-height: 750px;
            max-height: 750px;
            overflow-y: auto;
            padding: 1.5em 2em;
        }
        
        /* 이미지 크기 조절 핸들 스타일 */
        .ck-widget.image .ck-widget__type-around .ck-widget__type-around__button {
            background: #fff;
            border-radius: 50%;
        }
        
        /* 이미지 리사이징 핸들 스타일 */
        .ck-widget.image.ck-widget_with-resizer .ck-widget__resizer {
            border: 2px solid #2196f3;
        }
        
        /* 코드 블록 스타일 */
        pre code.hljs {
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: #f8f9fa;
        }
        
        /* 코드 블록 언어 스타일 */
        .ck-content pre {
            position: relative;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1em;
            margin: 1em 0;
            white-space: pre-wrap;
        }
        
        /* 텍스트 색상 문제 해결을 위한 스타일 */
        .ck-editor__editable p, 
        .ck-editor__editable h1, 
        .ck-editor__editable h2, 
        .ck-editor__editable h3, 
        .ck-editor__editable h4, 
        .ck-editor__editable h5, 
        .ck-editor__editable h6, 
        .ck-editor__editable li {
            color: #000 !important;
        }
        
        /* 코드 블록 내 텍스트 색상 */
        .ck-editor__editable pre code {
            color: #000 !important;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        
        /* 모든 텍스트 요소에 강제 적용 */
        .ck-editor__editable * {
            color: #000 !important;
        }
        
        /* 링크 텍스트도 검은색으로 (hover 상태 제외) */
        .ck-editor__editable a:not(:hover) {
            color: #000 !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8 col-md-7">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>{{ title }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="글 제목") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            
                            <!-- 편집 모드 전환 버튼 -->
                            <div class="d-flex justify-content-end mb-2">
                                <div class="btn-group" role="group">
                                    <button type="button" id="wysiwyg-mode" class="btn btn-sm btn-primary active">일반 편집기</button>
                                    <button type="button" id="markdown-mode" class="btn btn-sm btn-outline-primary">마크다운 편집</button>
                                </div>
                            </div>
                            
                            <!-- 폼 전송을 위한 숨겨진 textarea -->
                            {{ form.content(class="form-control d-none" + (" is-invalid" if form.content.errors else ""), rows=25, placeholder="내용을 입력하세요...", id="content", **{'data-autosave-key': (post_id if post_id else 'new')}) }}
                            
                            <!-- CKEditor 영역 -->
                            <div id="editor-container">
                                <div id="editor">{{ form.content.data|safe if form.content.data else '' }}</div>
                            </div>
                            
                            <!-- 마크다운 편집 영역 -->
                            <div id="markdown-container" style="display: none;">
                                <textarea class="form-control" id="markdown-editor" rows="20" style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;"></textarea>
                                <div class="d-flex justify-content-between mt-2">
                                    <small class="text-muted">마크다운 문법을 사용하여 작성하세요.</small>
                                    <button type="button" id="preview-markdown" class="btn btn-sm btn-outline-secondary">미리보기</button>
                                </div>
                                <!-- 마크다운 미리보기 영역 -->
                                <div id="markdown-preview" class="mt-3 p-3 border rounded" style="display: none;"></div>
                            </div>
                            
                            {% if form.content.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.content.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4 col-md-5">
                <div class="card sticky-top" style="top: 20px;"> 
                    <div class="card-header">
                        <h4>Publishing Options</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else ""), accept="image/*") }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if current_image_url %}
                                <div class="mt-3">
                                    <p class="mb-2 fw-bold">현재 이미지 미리보기</p>
                                    
                                    <!-- 메인 이미지 -->
                                    <div class="mb-3">
                                        <p class="mb-1"><small>메인 이미지 (1200x630px):</small></p>
                                        <img src="{{ current_image_url }}" 
                                             alt="{% if post.alt_text %}{{ post.alt_text }}{% else %}게시물 표지 이미지{% endif %}" 
                                             class="img-fluid rounded border" 
                                             style="max-height: 200px; max-width: 100%; object-fit: contain;">
                                    </div>
                                    
                                    <!-- 썸네일 미리보기 -->
                                    {% if current_thumbnail_url %}
                                    <div>
                                        <p class="mb-1"><small>썸네일 미리보기 (300x200px):</small></p>
                                        <img src="{{ current_thumbnail_url }}" 
                                             alt="{% if post.alt_text %}{{ post.alt_text }} (썸네일){% else %}게시물 썸네일 이미지{% endif %}" 
                                             class="img-thumbnail" 
                                             style="max-height: 100px; max-width: 150px; object-fit: cover;">
                                    </div>
                                    {% endif %}
                                    
                                    <!-- 이미지 설명 -->
                                    {% if post.alt_text %}
                                        <div class="alert alert-light mt-2 p-2">
                                            <small class="text-muted">
                                                <i class="bi bi-card-text"></i> 
                                                <strong>이미지 설명:</strong> {{ post.alt_text }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            {% elif post and not current_image_url %}
                                <div class="alert alert-warning mt-2">
                                    <small><i class="bi bi-exclamation-triangle"></i> 이미지가 업로드되지 않았습니다.</small>
                                </div>
                            {% endif %}
                            
                            <!-- 이미지 설명 입력 필드 -->
                            <div class="mt-3">
                                {{ form.alt_text.label(class="form-label") }}
                                {{ form.alt_text(class="form-control" + (" is-invalid" if form.alt_text.errors else ""), 
                                              placeholder="이미지 설명을 입력하세요 (SEO 및 접근성 향상에 도움이 됨)",
                                              rows="2") }}
                                {% if form.alt_text.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.alt_text.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <small>
                                        <i class="bi bi-info-circle"></i> 
                                        이미지에 대한 설명을 입력하세요. 이 설명은 화면 낭독기 사용자와 검색 엔진에 표시됩니다.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.video_embed_url.label(class="form-label") }}
                            {{ form.video_embed_url(class="form-control" + (" is-invalid" if form.video_embed_url.errors else ""), placeholder="e.g., YouTube URL") }}
                            {% if form.video_embed_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.video_embed_url.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select", **{'id': 'category'}) }}
                            <small class="text-muted d-block mt-1">현재 선택된 값: <span id="current-category-value">{{ form.category.data if form.category.data else 'None' }}</span></small>
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.category.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            <div class="tag-input-container">
                                <div class="tags-container form-control d-flex flex-wrap gap-1 p-1" id="tags-display">
                                    <!-- Tags will be displayed here -->
                                    <input type="text" id="tag-input" class="tag-input flex-grow-1 border-0" placeholder="입력 후 Tab키 누르면 태그 추가" style="outline: none; min-width: 100px;">
                                </div>
                                {{ form.tags(class="d-none" + (" is-invalid" if form.tags.errors else ""), id="actual-tags-input") }}
                                <small class="form-text text-muted">태그를 입력하고 Tab 키를 누르면 태그가 추가됩니다.</small>
                            </div>
                            {% if form.tags.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tags.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- 태그 입력을 위한 CSS 스타일 -->
                        <style>
                            .tag-item {
                                background-color: #375a7f; /* 어두운 테마에 맞는 태그 배경색 */
                                color: #fff; /* 태그 텍스트 색상 */
                                border-radius: 4px;
                                padding: 3px 10px;
                                margin-right: 5px;
                                margin-bottom: 5px;
                                display: inline-flex;
                                align-items: center;
                            }
                            .tag-remove {
                                margin-left: 8px;
                                cursor: pointer;
                                font-weight: bold;
                                color: #adb5bd; /* 삭제 버튼 색상 */
                            }
                            .tag-remove:hover {
                                color: #fff; /* 호버 시 삭제 버튼 색상 */
                            }
                            .tag-input {
                                background: transparent;
                                color: #fff; /* 입력창 텍스트 색상 */
                            }
                            .tags-container {
                                background-color: #222; /* 태그 컨테이너 배경색 */
                                border-color: #444;
                                color: #fff;
                            }
                            .tags-container:focus-within {
                                border-color: #375a7f; /* 포커스 시 테두리 색상 */
                                outline: 0;
                                box-shadow: 0 0 0 0.25rem rgba(55, 90, 127, 0.25);
                            }
                        </style>
                    </div>
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" name="save_draft" value="true" class="btn btn-info me-md-2">Save Draft</button>
                            <button type="submit" name="publish" value="true" class="btn btn-primary">{{ 'Publish' if not post else 'Update Post' }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // 태그 입력 처리 스크립트
    document.addEventListener('DOMContentLoaded', function() {
        const tagInput = document.getElementById('tag-input');
        const tagsContainer = document.getElementById('tags-display');
        const actualTagsInput = document.getElementById('actual-tags-input');
        
        // 기존 태그가 있으면 로드
        loadExistingTags();
        
        // Tab 키를 사용해 태그 추가 처리
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault(); // 기본 Tab 동작 차단
                addTag();
            } else if (e.key === 'Enter') {
                // Enter 키도 태그 추가로 처리하지만 폼 제출은 방지
                e.preventDefault();
                addTag();
            } else if (e.key === 'Backspace' && tagInput.value === '') {
                // 입력창이 비어있고 Backspace를 누르면 마지막 태그 삭제
                const tags = tagsContainer.querySelectorAll('.tag-item');
                if (tags.length > 0) {
                    removeTag(tags[tags.length - 1]);
                }
            }
        });
        
        // 태그 추가 함수
        function addTag() {
            const tagValue = tagInput.value.trim();
            if (tagValue) {
                createTagElement(tagValue);
                tagInput.value = '';
                updateActualInput();
            }
        }
        
        // 태그 삭제 함수
        function removeTag(tagElement) {
            tagsContainer.removeChild(tagElement);
            updateActualInput();
        }
        
        // 태그 요소 생성 함수
        function createTagElement(tagText) {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-item';
            tagElement.innerHTML = `
                ${tagText}
                <span class="tag-remove">&times;</span>
            `;
            
            // 삭제 버튼 이벤트 추가
            const removeButton = tagElement.querySelector('.tag-remove');
            removeButton.addEventListener('click', function() {
                removeTag(tagElement);
            });
            
            // 태그 입력 필드 앞에 태그 추가
            tagsContainer.insertBefore(tagElement, tagInput);
        }
        
        // 실제 폼 입력값 업데이트
        function updateActualInput() {
            const tags = [];
            tagsContainer.querySelectorAll('.tag-item').forEach(function(tag) {
                const tagText = tag.textContent.trim().replace('×', '').trim();
                if (tagText) tags.push(tagText);
            });
            
            // 콌마로 구분된 텍스트 형태로 저장 (백엔드 호환성)
            actualTagsInput.value = tags.join(', ');
            console.log('태그 업데이트:', actualTagsInput.value);
        }
        
        // 기존 태그 로드 함수
        function loadExistingTags() {
            if (actualTagsInput.value) {
                const existingTags = actualTagsInput.value.split(',').map(tag => tag.trim());
                existingTags.forEach(tag => {
                    if (tag) createTagElement(tag);
                });
            }
        }
    });
    
    // 전역 변수로 정의된 window.ADMIN_TOKEN 사용

    document.addEventListener('DOMContentLoaded', function() {
        const contentElement = document.getElementById('content');
        const autosaveKey = contentElement.dataset.autosaveKey;

        // CKEditor Super-build 초기화 - 코드 블록과 이미지 크기 조절 기능 포함
        CKEDITOR.ClassicEditor
            .create(document.querySelector('#editor'), {
                placeholder: '내용을 입력하세요...',
                language: 'ko',
                // 커스텀 업로드 어덧터 사용 - 처음 설정으로 돌아가기
                extraPlugins: [MyCustomUploadAdapterPlugin],
                
                // 이미지 업로드 설정 - 두 가지 방식 모두 설정
                simpleUpload: {
                    uploadUrl: '{{ url_for("admin.upload_editor_image") }}',
                    // 헤더에 인증 토큰 추가
                    headers: {
                        'Authorization': 'Bearer ' + window.ADMIN_TOKEN,
                        'X-CSRF-TOKEN': window.CSRF_TOKEN
                    }
                },
                // 에디터 플러그인 설정
                plugins: [
                    // 필수 기본 플러그인
                    'Essentials',
                    
                    // 텍스트 서식
                    'Bold',
                    'Italic',
                    'Underline',
                    'Strikethrough',
                    'Code',
                    
                    // 단락 관련 기능
                    'Paragraph',
                    'Heading',
                    'Alignment',
                    'BlockQuote',
                    
                    // 리스트 관련 기능
                    'List',
                    'Indent',
                    
                    // 기타 요소
                    'Link',
                    'Image',
                    'ImageCaption',
                    'ImageStyle',
                    'ImageToolbar',
                    'ImageUpload',
                    'ImageResize',  // 이미지 리사이즈 플러그인 추가
                    'Table',
                    'TableToolbar',
                    'CodeBlock',
                    'MediaEmbed',
                    'HorizontalLine',
                    
                    // 사용자 지원 기능
                    'SourceEditing',
                    'PasteFromOffice',
                    'RemoveFormat',
                    'FindAndReplace',
                    
                    // 해당 플러그인이 문제를 일으킬 수 있으니 제거
                    // 'TextTransformation'
                ],
                
                // 코드 블록 설정
                codeBlock: {
                    languages: [
                        { language: 'plaintext', label: '일반 텍스트' },
                        { language: 'mermaid', label: 'Mermaid 다이어그램' },
                        { language: 'c', label: 'C' },
                        { language: 'cs', label: 'C#' },
                        { language: 'cpp', label: 'C++' },
                        { language: 'css', label: 'CSS' },
                        { language: 'diff', label: 'Diff' },
                        { language: 'html', label: 'HTML' },
                        { language: 'java', label: 'Java' },
                        { language: 'javascript', label: 'JavaScript' },
                        { language: 'php', label: 'PHP' },
                        { language: 'python', label: 'Python' },
                        { language: 'ruby', label: 'Ruby' },
                        { language: 'typescript', label: 'TypeScript' },
                        { language: 'xml', label: 'XML' },
                        { language: 'bash', label: 'Bash' },
                        { language: 'json', label: 'JSON' },
                        { language: 'sql', label: 'SQL' },
                        { language: 'powershell', label: 'PowerShell' }
                    ]
                },
                // 툴바 구성 - 플러그인과 일치하도록 항목 수정
                toolbar: {
                    items: [
                        'heading', 'bold', 'italic', 'underline', 'strikethrough', 'code',
                        '|',
                        'alignment', 'blockQuote',
                        '|',
                        'bulletedList', 'numberedList',
                        '|',
                        'indent', 'outdent',
                        '|',
                        'link', 'insertTable', 'uploadImage', 'mediaEmbed',
                        '|',
                        'codeBlock', 'sourceEditing', 'horizontalLine',
                        '|',
                        'findAndReplace', 'removeFormat',
                        '|',
                        'undo', 'redo'
                    ]
                },
                // 이미지 관련 설정 - Super-build에 맞게 수정
                image: {
                    // 이미지 스타일 설정
                    styles: {
                        options: [
                            'alignCenter', 
                            'alignLeft', 
                            'alignRight', 
                            'block', 
                            'side'
                        ]
                    },
                    // 이미지 툴바 구성 - 리사이즈 기능 포함
                    toolbar: [
                        'imageStyle:alignLeft', 'imageStyle:alignCenter', 'imageStyle:alignRight',
                        '|',
                        'imageTextAlternative',
                        '|',
                        'toggleImageCaption',
                        '|',
                        'resizeImage:25', 'resizeImage:50', 'resizeImage:75', 'resizeImage:original'
                    ],
                    
                    // 이미지 리사이즈 설정
                    resizeOptions: [
                        {
                            name: 'resizeImage:original',
                            value: null,
                            icon: 'original'
                        },
                        {
                            name: 'resizeImage:25',
                            value: '25',
                            icon: 'small'
                        },
                        {
                            name: 'resizeImage:50',
                            value: '50',
                            icon: 'medium'
                        },
                        {
                            name: 'resizeImage:75',
                            value: '75',
                            icon: 'large'
                        }
                    ],
                    resizeUnit: '%'
                },
                // 테이블 구성
                table: {
                    contentToolbar: [
                        'tableColumn',
                        'tableRow',
                        'mergeTableCells',
                        'tableCellProperties',
                        'tableProperties'
                    ]
                }
            })
            .then(editor => {
                // 에디터 인스턴스 저장
                window.editor = editor;
                
                // highlight.js로 코드 구문 강조 적용 - HTML 이스케이프 처리
                function applyHighlighting() {
                    document.querySelectorAll('pre code').forEach((block) => {
                        // 이미 강조된 요소인지 확인
                        if (!block.dataset.highlighted) {
                            // HTML 이스케이프 처리
                            const text = block.textContent;
                            const node = document.createTextNode(text);
                            block.textContent = '';
                            block.appendChild(node);
                            
                            // 구문 강조 적용
                            hljs.highlightElement(block);
                            block.dataset.highlighted = 'true';
                        }
                    });
                }
                
                // 코드 블록이 삽입되면 구문 강조 적용 (디바운스로 성능 최적화)
                let highlightTimeout;
                editor.model.document.on('change:data', () => {
                    clearTimeout(highlightTimeout);
                    highlightTimeout = setTimeout(applyHighlighting, 300);
                });
                
                // 초기 구문 강조 적용 (약간의 지연을 두어 DOM이 완전히 로드된 후 실행)
                setTimeout(applyHighlighting, 500);
                
                console.log('CKEditor 초기화 완료');
                
                // 폼 제출 시 hidden input에 내용 저장 (완전히 개선된 버전)
                const form = document.querySelector('form');
                const contentField = document.getElementById('content');
                
                // 폼 제출을 위한 함수
                function submitPostForm(buttonName, buttonValue) {
                    try {
                        let content = '';
                        
                        // 마크다운 모드인 경우 마크다운을 HTML로 변환
                        if (markdownContainer.style.display !== 'none') {
                            console.log('마크다운 모드에서 제출 시도');
                            const markdownText = markdownEditor.value;
                            if (markdownText.trim().length === 0) {
                                alert('내용을 입력해주세요.');
                                return false;
                            }
                            // 마크다운을 HTML로 변환
                            content = marked.parse(markdownText, {
                                gfm: true,
                                breaks: true,
                                sanitize: false
                            });
                            console.log('마크다운에서 변환된 HTML 길이:', content.length);
                        } else {
                            // 일반 에디터 모드인 경우
                            content = editor.getData();
                            if (content.trim().length === 0) {
                                alert('내용을 입력해주세요.');
                                return false;
                            }
                            console.log('에디터 내용 길이:', content.length);
                        }
                        
                        // 원본 폼 가져오기
                        const form = document.querySelector('form');
                        
                        // FormData 객체 생성 (파일 업로드 지원)
                        const formData = new FormData();
                        
                        // 제목 필드 수동으로 추가 (가장 먼저 추가)
                        const postForm = document.querySelector('form[method="POST"]');
                        if (!postForm) {
                            console.error('Post form not found!');
                            return false;
                        }
                        
                        const titleInput = postForm.querySelector('input[name="title"]');
                        if (titleInput) {
                            console.log('Title field found, value:', titleInput.value);
                            formData.append('title', titleInput.value);
                        } else {
                            console.error('Title input not found in post form!');
                            return false;
                        }
                        
                        // 폼의 모든 필드 추가
                        const formElements = form.elements;
                        for (let i = 0; i < formElements.length; i++) {
                            const element = formElements[i];
                            
                            // 파일 입력 필드는 나중에 처리
                            if (element.type === 'file' || element.name === 'title') {
                                continue;
                            }
                            
                            // 체크박스나 라디오 버튼 처리
                            if ((element.type === 'checkbox' || element.type === 'radio') && !element.checked) {
                                continue;
                            }
                            
                            // 이름이 있는 필드만 추가
                            if (element.name && element.name !== 'title') {
                                console.log('Adding field:', element.name, '=', element.value);
                                formData.append(element.name, element.value);
                            }
                        }
                        
                        // 타이틀 필드가 비어있는지 확인 (이미 위에서 titleInput을 선언했으므로 재사용)
                        if (!titleInput.value.trim()) {
                            alert('제목을 입력해주세요.');
                            return false;
                        }
                        
                        // 에디터 내용 업데이트
                        formData.set('content', content);
                        
                        // 버튼 상태 추가
                        formData.append(buttonName, buttonValue || 'true');
                        
                        // 파일 업로드 필드 처리
                        const fileInput = postForm.querySelector('input[type="file"][name="image"]');
                        if (fileInput && fileInput.files.length > 0) {
                            console.log('Adding cover image to form data:', fileInput.files[0].name);
                            formData.append('image', fileInput.files[0]);
                        } else {
                            console.log('이미지 파일이 첨부되지 않았습니다.');
                        }
                        
                        // XMLHttpRequest를 사용하여 폼 제출
                        const xhr = new XMLHttpRequest();
                        // 현재 URL이 편집 모드인지 확인 (post_id가 있는지)
                        const isEditMode = window.location.pathname.includes('/edit/');
                        const actionUrl = isEditMode ? window.location.pathname : "{{ url_for('admin.new_post') }}";
                        xhr.open('POST', actionUrl, true);
                        
                        // CSRF 토큰 추가
                        const csrfToken = document.querySelector('input[name="csrf_token"]');
                        if (csrfToken) {
                            xhr.setRequestHeader('X-CSRFToken', csrfToken.value);
                            formData.append('csrf_token', csrfToken.value);
                        }
                        
                        xhr.onload = function() {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                // 성공 시 페이지 새로고침
                                window.location.reload();
                            } else {
                                console.error('서버 오류:', xhr.status, xhr.statusText);
                                alert('게시글 저장 중 오류가 발생했습니다. 다시 시도해주세요.');
                            }
                        };
                        
                        xhr.onerror = function() {
                            console.error('네트워크 오류');
                            alert('네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.');
                        };
                        
                        console.log('폼 데이터 전송 중...');
                        xhr.send(formData);
                        return true;
                    } catch (error) {
                        console.error('폼 제출 중 오류 발생:', error);
                        alert('게시글 저장 중 오류가 발생했습니다: ' + error.message);
                        return false;
                    }
                }
                
                // 폼 제출 이벤트 리스너 추가
                const postForm = document.querySelector('form');
                postForm.addEventListener('submit', function(e) {
                    e.preventDefault(); // 기본 폼 제출 방지
                    
                    // 클릭된 버튼 찾기
                    const submitButton = document.activeElement;
                    if (submitButton && submitButton.type === 'submit') {
                        const buttonName = submitButton.name;
                        const buttonValue = submitButton.value || 'true';
                        submitPostForm(buttonName, buttonValue);
                    } else {
                        // 기본값으로 저장
                        submitPostForm('publish', 'true');
                    }
                });
                
                // 기존 버튼 이벤트 리스너 제거
                document.querySelectorAll('button[type="submit"]').forEach(button => {
                    button.onclick = null;
                });
                
                // 제출 버튼에 클릭 이벤트 리스너 추가 (이벤트 위임을 위해)
                document.querySelector('form').addEventListener('click', function(e) {
                    if (e.target && e.target.type === 'submit') {
                        e.preventDefault();
                        const buttonName = e.target.name || 'publish';
                        const buttonValue = e.target.value || 'true';
                        submitPostForm(buttonName, buttonValue);
                    }
                });
                
                // 기존 폼 제출 이벤트는 무시
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('기존 폼 제출 차단됨');
                });
                
                // 마크다운 모드와 일반 편집기 모드 전환 기능 추가
                const wysiwygModeBtn = document.getElementById('wysiwyg-mode');
                const markdownModeBtn = document.getElementById('markdown-mode');
                const editorContainer = document.getElementById('editor-container');
                const markdownContainer = document.getElementById('markdown-container');
                const markdownEditor = document.getElementById('markdown-editor');
                const markdownPreview = document.getElementById('markdown-preview');
                const previewMarkdownBtn = document.getElementById('preview-markdown');
                
                // HTML을 마크다운으로 변환하는 함수 (단순화된 전환)
                function htmlToMarkdown(html) {
                    // 기본적인 변환 작업
                    let markdown = html;
                    
                    // 텍스트 정리
                    markdown = markdown.replace(/\n\s+/g, '\n');
                    
                    // 테그 변환
                    markdown = markdown.replace(/<h1[^>]*>(.+?)<\/h1>/gi, '# $1\n');
                    markdown = markdown.replace(/<h2[^>]*>(.+?)<\/h2>/gi, '## $1\n');
                    markdown = markdown.replace(/<h3[^>]*>(.+?)<\/h3>/gi, '### $1\n');
                    markdown = markdown.replace(/<h4[^>]*>(.+?)<\/h4>/gi, '#### $1\n');
                    markdown = markdown.replace(/<h5[^>]*>(.+?)<\/h5>/gi, '##### $1\n');
                    markdown = markdown.replace(/<h6[^>]*>(.+?)<\/h6>/gi, '###### $1\n');
                    
                    markdown = markdown.replace(/<strong>(.+?)<\/strong>/gi, '**$1**');
                    markdown = markdown.replace(/<b>(.+?)<\/b>/gi, '**$1**');
                    markdown = markdown.replace(/<em>(.+?)<\/em>/gi, '*$1*');
                    markdown = markdown.replace(/<i>(.+?)<\/i>/gi, '*$1*');
                    markdown = markdown.replace(/<code>(.+?)<\/code>/gi, '`$1`');
                    
                    // 리스트 변환
                    markdown = markdown.replace(/<ul[^>]*>([\s\S]*?)<\/ul>/gi, function(match, content) {
                        return content.replace(/<li[^>]*>([\s\S]*?)<\/li>/gi, '- $1\n');
                    });
                    
                    markdown = markdown.replace(/<ol[^>]*>([\s\S]*?)<\/ol>/gi, function(match, content) {
                        let counter = 1;
                        return content.replace(/<li[^>]*>([\s\S]*?)<\/li>/gi, function(match, item) {
                            return (counter++) + '. ' + item + '\n';
                        });
                    });
                    
                    // 링크 변환
                    markdown = markdown.replace(/<a[^>]*href=["']([^"']+)["'][^>]*>(.+?)<\/a>/gi, '[$2]($1)');
                    
                    // 이미지 변환 - 더 강력한 이미지 태그 처리
                    markdown = markdown.replace(/<img[^>]*src=["']([^"']+)["'][^>]*(?:alt=["']([^"']*))?["']?[^>]*\/?>/gi, function(match, src, alt) {
                        console.log('이미지 변환:', src, alt || '');
                        return '!['+ (alt || '') + '](' + src + ')';
                    });
                    
                    // figure와 figcaption을 포함한 이미지 처리
                    markdown = markdown.replace(/<figure[^>]*>\s*<img[^>]*src=["']([^"']+)["'][^>]*(?:alt=["']([^"']*))?["']?[^>]*\/?>[\s\S]*?<figcaption[^>]*>([\s\S]*?)<\/figcaption>[\s\S]*?<\/figure>/gi, 
                        function(match, src, alt, caption) {
                            console.log('캐프션 이미지 변환:', src, alt || '', caption);
                            return '!['+ (alt || caption || '') + '](' + src + ')';
                        }
                    );
                    
                    // 코드 블록 변환
                    markdown = markdown.replace(/<pre[^>]*><code[^>]*class=["']language-([^"']+)["'][^>]*>([\s\S]*?)<\/code><\/pre>/gi, 
                        function(match, language, code) {
                            return '```' + language + '\n' + code.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&') + '\n```\n';
                        }
                    );
                    
                    // 단락 처리
                    markdown = markdown.replace(/<p[^>]*>([\s\S]*?)<\/p>/gi, '$1\n\n');
                    
                    // 인용문 변환
                    markdown = markdown.replace(/<blockquote[^>]*>([\s\S]*?)<\/blockquote>/gi, function(match, content) {
                        return content.replace(/<p[^>]*>([\s\S]*?)<\/p>/gi, '> $1\n');
                    });
                    
                    // HTML 테그 제거
                    markdown = markdown.replace(/<[^>]+>/g, '');
                    
                    // HTML 엔티티 변환
                    markdown = markdown.replace(/&nbsp;/g, ' ');
                    markdown = markdown.replace(/&lt;/g, '<');
                    markdown = markdown.replace(/&gt;/g, '>');
                    markdown = markdown.replace(/&amp;/g, '&');
                    
                    // 여러 줄바꿈 정리
                    markdown = markdown.replace(/\n{3,}/g, '\n\n');
                    
                    return markdown;
                }
                
                // 마크다운에서 WYSIWYG 모드로 전환
                wysiwygModeBtn.addEventListener('click', function() {
                    if (markdownContainer.style.display !== 'none') {
                        // 마크다운 텍스트를 HTML로 변환
                        const markdownText = markdownEditor.value;
                        console.log('마크다운 모드에서 일반 편집기로 전환 시도:', markdownText.substring(0, 100) + '...');
                        
                        try {
                            // marked.js를 사용하여 마크다운을 HTML로 변환
                            const htmlContent = marked.parse(markdownText, {
                                gfm: true,            // GitHub Flavored Markdown 사용
                                breaks: true,         // 줄바꿈을 <br>로 변환
                                sanitize: false,       // HTML 태그 허용
                                pedantic: false,      // 마크다운 사양에 맞춤
                                smartLists: true,      // 스마트 리스트
                                smartypants: true     // 인용부호 등 변환
                            });
                            
                            console.log('변환된 HTML:', htmlContent.substring(0, 100) + '...');
                            
                            // CKEditor에 HTML 설정
                            editor.setData(htmlContent);
                            
                            // UI 업데이트
                            markdownContainer.style.display = 'none';
                            editorContainer.style.display = 'block';
                            markdownPreview.style.display = 'none';
                        } catch (error) {
                            console.error('마크다운 변환 오류:', error);
                            alert('마크다운에서 HTML로 변환 중 오류가 발생했습니다.');
                        }
                        
                        wysiwygModeBtn.classList.add('active');
                        wysiwygModeBtn.classList.remove('btn-outline-primary');
                        wysiwygModeBtn.classList.add('btn-primary');
                        
                        markdownModeBtn.classList.remove('active');
                        markdownModeBtn.classList.remove('btn-primary');
                        markdownModeBtn.classList.add('btn-outline-primary');
                    }
                });
                
                // WYSIWYG에서 마크다운 모드로 전환
                markdownModeBtn.addEventListener('click', function() {
                    if (editorContainer.style.display !== 'none') {
                        // CKEditor의 HTML 콘텐츠 가져오기
                        const htmlContent = editor.getData();
                        
                        // HTML을 마크다운으로 변환
                        const markdownText = htmlToMarkdown(htmlContent);
                        markdownEditor.value = markdownText;
                        
                        // UI 업데이트
                        editorContainer.style.display = 'none';
                        markdownContainer.style.display = 'block';
                        
                        markdownModeBtn.classList.add('active');
                        markdownModeBtn.classList.remove('btn-outline-primary');
                        markdownModeBtn.classList.add('btn-primary');
                        
                        wysiwygModeBtn.classList.remove('active');
                        wysiwygModeBtn.classList.remove('btn-primary');
                        wysiwygModeBtn.classList.add('btn-outline-primary');
                    }
                });
                
                // 마크다운 미리보기 기능
                previewMarkdownBtn.addEventListener('click', function() {
                    const markdownText = markdownEditor.value;
                    const htmlContent = marked.parse(markdownText);
                    
                    markdownPreview.innerHTML = htmlContent;
                    
                    // 코드 하이라이팅 적용
                    markdownPreview.querySelectorAll('pre code').forEach((block) => {
                        // Mermaid 코드 블록인지 확인
                        if (block.className.includes('language-mermaid')) {
                            // Mermaid 다이어그램 처리
                            const preElement = block.parentElement;
                            const content = block.textContent.trim();
                            const div = document.createElement('div');
                            div.className = 'mermaid';
                            div.innerHTML = content;
                            preElement.replaceWith(div);
                        } else {
                            // 일반 코드 블록 하이라이팅
                            hljs.highlightElement(block);
                        }
                    });
                    
                    // Mermaid 다이어그램 초기화 및 렌더링
                    setTimeout(() => {
                        mermaid.initialize({
                            startOnLoad: true,
                            theme: 'dark',
                            securityLevel: 'loose'
                        });
                        mermaid.init(undefined, markdownPreview.querySelectorAll('.mermaid'));
                    }, 100);
                    
                    // 미리보기 표시/숨김 토글
                    if (markdownPreview.style.display === 'none') {
                        markdownPreview.style.display = 'block';
                        previewMarkdownBtn.textContent = '미리보기 숨기기';
                    } else {
                        markdownPreview.style.display = 'none';
                        previewMarkdownBtn.textContent = '미리보기';
                    }
                });
                
                // 폼 제출 전 현재 작성 내용 저장
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('폼 제출 중...');
                    
                    // 현재 어떤 모드인지 확인하고 해당 내용을 저장
                    if (markdownContainer.style.display !== 'none') {
                        // 마크다운 모드인 경우
                        const markdownText = markdownEditor.value;
                        const htmlContent = marked.parse(markdownText);
                        contentField.value = htmlContent;
                        console.log('마크다운에서 HTML로 변환하여 저장');
                    } else {
                        // WYSIWYG 모드인 경우
                        contentField.value = editor.getData();
                        console.log('CKEditor 내용 저장');
                    }
                });
                
                // 자동 저장 기능 추가
                
                // 이제 simpleUpload 플러그인을 통해 이미지 업로드가 자동으로 처리됨
                console.log('이미지 업로드 기능 준비 완료');
                
                // 자동 저장 기능 구현
                const saveData = () => {
                    const data = editor.getData();
                    localStorage.setItem('ckeditor-autosave-' + autosaveKey, data);
                };
                
                // 30초마다 자동 저장
                const autosaveInterval = setInterval(saveData, 30000);
                
                // 페이지 언로드 시 자동 저장 중지
                window.addEventListener('beforeunload', () => {
                    clearInterval(autosaveInterval);
                    saveData(); // 페이지 나가기 전 마지막 저장
                });
                
                // 자동 저장된 내용 복원
                const savedData = localStorage.getItem('ckeditor-autosave-' + autosaveKey);
                if (savedData && !editor.getData()) {
                    editor.setData(savedData);
                }
                
                console.log('CKEditor 초기화 완료');
            })
            .catch(error => {
                console.error('CKEditor 초기화 오류:', error);
            });
    });
</script>
{% endblock %}
