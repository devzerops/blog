{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_field %}

{% block title %}{{ post.title }}{% endblock %}
{% block meta_description %}{{ meta_description if meta_description else post.title }}{% endblock %}

{% block main_container_class %}container-fluid{% endblock %}

{% block head_extra %}
    <!-- Prism CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.css" rel="stylesheet" />
    <style>
        .post-content img { max-width: 100%; height: auto; border-radius: 0.25rem; margin-bottom: 1rem; }
        .post-content .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            margin-bottom: 1rem;
        }
        .post-content .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Ensure pre tags scroll horizontally if content is too wide */
        .post-content pre[class*="language-"] {
            overflow-x: auto;
        }
        /* Ensure long words wrap within the post content area */
        .post-content {
            overflow-wrap: break-word;
            word-wrap: break-word; /* Older browsers */
            -ms-word-break: break-all; /* IE10+ */
            word-break: break-word; /* Non-standard for WebKit/Blink, but often works */
        }
    </style>
{% endblock %}

{% block content %}
<!-- Off-canvas Filter Button (Mobile Only) -->
<div class="d-md-none mb-3 text-end">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">
        <i class="bi bi-funnel-fill"></i> 필터
    </button>
</div>

<div class="row mt-4">    
    <!-- Left Sidebar for Filters -->
    <div class="d-none d-md-block col-md-2 ps-lg-4 ps-md-3 ps-2 pe-2">
        <div class="sticky-top" style="top: 20px;"> 
            <h5><i class="bi bi-tags-fill me-2"></i>태그</h5>
            <div class="list-group list-group-flush mb-4">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2" data-bs-toggle="collapse" href="#collapseTagsDesktop" role="button" aria-expanded="true" aria-controls="collapseTagsDesktop">
                    <span>태그 목록</span> <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse show" id="collapseTagsDesktop">
                    <div class="list-group list-group-flush ps-2">
                        <a href="{{ url_for('public.post_list') }}" class="list-group-item list-group-item-action py-1 {% if not tag_filter and not selected_category_id %}active{% endif %}">
                            <i class="bi bi-tags me-1"></i> 모든 태그
                        </a>
                        {% if all_tags %}
                            {% for tag_item in all_tags %}
                                <a href="{{ url_for('public.post_list', tag=tag_item) }}" class="list-group-item list-group-item-action py-1 {% if tag_filter == tag_item %}active{% endif %}">
                                    <i class="bi bi-tag-fill me-1"></i> {{ tag_item }}
                                </a>
                            {% endfor %}
                        {% else %}
                            <span class="list-group-item py-1 text-muted"><i class="bi bi-tag me-1"></i> 태그 없음</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <h5><i class="bi bi-bookmarks-fill me-2"></i>카테고리</h5>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2" data-bs-toggle="collapse" href="#collapseCategoriesDesktop" role="button" aria-expanded="true" aria-controls="collapseCategoriesDesktop">
                    <span>카테고리 목록</span> <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse show" id="collapseCategoriesDesktop">
                    <div class="list-group list-group-flush ps-2">
                        <a href="{{ url_for('public.post_list') }}" class="list-group-item list-group-item-action py-1 {% if not selected_category_id and not tag_filter %}active{% endif %}">
                            <i class="bi bi-folder me-1"></i> 모든 카테고리
                        </a>
                        {% for category_item in all_categories %}
                            <a href="{{ url_for('public.post_list', category_id=category_item.id) }}" class="list-group-item list-group-item-action py-1 {% if selected_category_id == category_item.id %}active{% endif %}">
                                <i class="bi bi-folder-fill me-1"></i> {{ category_item.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 메인 콘텐츠 영역 -->
    <div class="col-12 col-md-8">
    <article class="blog-post">
        <header class="mb-4">
            <h1 class="display-5 fw-bold">{{ title }}</h1>
            <p class="text-muted">
                작성일: {{ post.created_at.strftime('%Y년 %m월 %d일 %H:%M') }}
                {% if post.updated_at and post.updated_at != post.created_at %}
                    | 수정일: {{ post.updated_at.strftime('%Y년 %m월 %d일 %H:%M') }}
                {% endif %}
                | 조회수: {{ post.views }}
            </p>
        </header>

        {% if image_url %}
            <img src="{{ image_url }}" class="img-fluid rounded mb-4 shadow-sm" alt="{{ post.alt_text if post.alt_text else post.title }}" style="max-height: 400px; width: 100%; object-fit: contain;">
        {% endif %}

        {% if post.video_embed_url %}
            <div class="video-container mb-4 shadow-sm">
                {% if 'youtube.com/watch?v=' in post.video_embed_url or 'youtu.be/' in post.video_embed_url %}
                    {% set video_id = post.video_embed_url.split('v=')[-1].split('&')[0] if 'youtube.com/watch?v=' in post.video_embed_url else post.video_embed_url.split('/')[-1].split('?')[0] %}
                    <iframe src="https://www.youtube.com/embed/{{ video_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                {% elif 'vimeo.com/' in post.video_embed_url %}
                    {% set video_id = post.video_embed_url.split('/')[-1].split('?')[0] %}
                    <iframe src="https://player.vimeo.com/video/{{ video_id }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                {% else %}
                    <p class="text-warning">지원되지 않는 동영상 URL입니다. YouTube 또는 Vimeo 링크를 사용해주세요.</p>
                {% endif %}
            </div>
        {% endif %}

        <div class="post-content lead">
            {{ html_content|safe }}
        </div>

        <hr class="my-5">

        {% if post.tags %}
        <div class="mb-3">
            <strong>태그:</strong>
            {% for tag_name in post.tags.split(',') %}
                {% if tag_name.strip() %}
                    <a href="{{ url_for('public.post_list', tag=tag_name.strip()) }}" class="badge bg-secondary text-decoration-none me-1">{{ tag_name.strip() }}</a>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <hr>

        {# Comments Section #}
        <section id="comments" class="my-5">
            <h3 class="mb-4">댓글 ({{ comments|length }})</h3>

            {% macro render_comment_node(comment, post_id, comment_form) %}
                <div class="card mb-3 shadow-sm {% if comment.parent_id %}ms-4 mt-2{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">{{ comment.nickname }}</h5>
                        <p class="card-text">{{ comment.content|nl2br }}</p>
                        <p class="card-text">
                            <small class="text-muted">
                                {{ comment.created_at.strftime('%Y년 %m월 %d일 %H:%M') }} - IP: {{ comment.ip_address | mask_ip }}
                            </small>
                            <button class="btn btn-sm btn-link reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                        </p>

                        {# Reply form - initially hidden #}
                        <div id="reply-form-{{ comment.id }}" class="reply-form mt-3" style="display: none;">
                            <form method="POST" action="{{ url_for('public.add_comment', post_id=post_id) }}" novalidate>
                                {{ comment_form.hidden_tag() }}
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                {{ render_field(comment_form.nickname, class="form-control mb-2", placeholder="Nickname") }}
                                {{ render_field(comment_form.content, class="form-control mb-2", rows=3, placeholder="Write a reply...") }}
                                <button type="submit" class="btn btn-primary btn-sm mt-2">Submit Reply</button>
                            </form>
                        </div>

                        {# Render replies recursively #}
                        {% if comment.replies %}
                            {% for reply in comment.replies.all() %}{# .all() because lazy='dynamic' #}
                                {{ render_comment_node(reply, post_id, comment_form) }}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endmacro %}

            {# Display Existing Comments - Updated to use the macro #}
            {% if comments %}
                {% for comment in comments %}
                    {{ render_comment_node(comment, post.id, comment_form) }}
                {% endfor %}
            {% else %}
                <p>아직 댓글이 없습니다. 첫 댓글을 남겨주세요!</p>
            {% endif %}

            {# Comment Submission Form for TOP-LEVEL comments #}
            <div class="mt-4 pt-4 border-top">
                <h4>댓글 남기기</h4>
                <form method="POST" action="{{ url_for('public.add_comment', post_id=post.id) }}" novalidate>
                    {{ comment_form.hidden_tag() }}
                    {{ render_field(comment_form.nickname, class="form-control mb-2") }}
                    {{ render_field(comment_form.content, class="form-control mb-2", rows=4) }}
                    <button type="submit" class="btn btn-primary mt-2">{{ comment_form.submit.label.text }}</button>
                </form>
            </div>
        </section>

        <div class="navigation-links">
            <a href="{{ url_for('public.post_list') }}" class="btn btn-outline-secondary">&laquo; 목록으로 돌아가기</a>
        </div>
    </article>
    </div>
    
    <!-- 광고 사이드바 영역 -->
    <div class="d-none d-md-block col-md-2 ps-2 pe-lg-4 pe-md-3 pe-2">
        <div class="sticky-top" style="top: 20px;">
            <h5><i class="bi bi-megaphone-fill me-2"></i>광고</h5>
            <div class="card mb-4">
                <div class="card-body text-center">
                    <p class="card-text text-muted">Google AdSense 영역</p>
                    <!-- AdSense code will go here -->
                    <div style="width:100%; height:250px; background-color:#f0f0f0; display:flex; align-items:center; justify-content:center;">
                        (광고 예시)
                    </div>
                </div>
            </div>
            
            <!-- 추가 광고 영역 -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <p class="card-text text-muted">관련 광고</p>
                    <div style="width:100%; height:200px; background-color:#f0f0f0; display:flex; align-items:center; justify-content:center;">
                        (광고 예시)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Off-canvas Sidebar for Filters -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="filterOffcanvasLabel">필터</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Content from the original left sidebar, now with dropdowns -->
        <h5><i class="bi bi-tags-fill me-2"></i>태그</h5>
        <div class="list-group list-group-flush mb-4">
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2" data-bs-toggle="collapse" href="#collapseTagsOffcanvas" role="button" aria-expanded="true" aria-controls="collapseTagsOffcanvas">
                <span>태그 목록</span> <i class="bi bi-chevron-down small"></i>
            </a>
            <div class="collapse show" id="collapseTagsOffcanvas">
                <div class="list-group list-group-flush ps-2">
                    <a href="{{ url_for('public.post_list') }}" class="list-group-item list-group-item-action py-1 {% if not tag_filter and not selected_category_id %}active{% endif %}">
                        <i class="bi bi-tags me-1"></i> 모든 태그
                    </a>
                    {% if all_tags %}
                        {% for tag_item in all_tags %}
                            <a href="{{ url_for('public.post_list', tag=tag_item) }}" class="list-group-item list-group-item-action py-1 {% if tag_filter == tag_item %}active{% endif %}">
                                <i class="bi bi-tag-fill me-1"></i> {{ tag_item }}
                            </a>
                        {% endfor %}
                    {% else %}
                        <span class="list-group-item py-1 text-muted"><i class="bi bi-tag me-1"></i> 태그 없음</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <h5><i class="bi bi-bookmarks-fill me-2"></i>카테고리</h5>
        <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2" data-bs-toggle="collapse" href="#collapseCategoriesOffcanvas" role="button" aria-expanded="true" aria-controls="collapseCategoriesOffcanvas">
                <span>카테고리 목록</span> <i class="bi bi-chevron-down small"></i>
            </a>
            <div class="collapse show" id="collapseCategoriesOffcanvas">
                <div class="list-group list-group-flush ps-2">
                    <a href="{{ url_for('public.post_list') }}" class="list-group-item list-group-item-action py-1 {% if not selected_category_id and not tag_filter %}active{% endif %}">
                        <i class="bi bi-folder me-1"></i> 모든 카테고리
                    </a>
                    {% for category_item in all_categories %}
                        <a href="{{ url_for('public.post_list', category_id=category_item.id) }}" class="list-group-item list-group-item-action py-1 {% if selected_category_id == category_item.id %}active{% endif %}">
                            <i class="bi bi-folder-fill me-1"></i> {{ category_item.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts_extra %}
    <!-- Prism JS for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script>
        Prism.plugins.toolbar.registerButton('select-code', function (env) {
            var button = document.createElement('button');
            button.innerHTML = 'Select Code';
            button.addEventListener('click', function () {
                if (document.selection) { // IE
                    var range = document.body.createTextRange();
                    range.moveToElementText(env.element);
                    range.select();
                } else if (window.getSelection) {
                    var range = document.createRange();
                    range.selectNode(env.element);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
            });
            return button;
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.reply-btn').forEach(button => {
            button.addEventListener('click', function () {
                const commentId = this.dataset.commentId;
                const replyForm = document.getElementById('reply-form-' + commentId);
                if (replyForm) {
                    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
    });
    </script>
{% endblock %}
