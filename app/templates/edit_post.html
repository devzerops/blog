{% extends "base.html" %}

{% block head_extra %}
    <!-- TinyMCE -->
    <script src="{{ url_for('static', filename='tinymce/tinymce.min.js') }}" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <h2>{{ title }}</h2>
        <form method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.title.label(class="form-label") }}
                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="글 제목") }}
                {% if form.title.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.title.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.content.label(class="form-label") }}
                {{ form.content(class="form-control" + (" is-invalid" if form.content.errors else ""), rows=15, placeholder="Markdown 형식으로 내용을 입력하세요...", id="content", **{'data-autosave-key': (post_id if post_id else 'new')}) }}
                {% if form.content.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.content.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.image.label(class="form-label") }}
                    {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                    {% if form.image.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.image.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if current_image_url %}
                        <div class="mt-2">
                            <p>현재 이미지:</p>
                            <img src="{{ current_image_url }}" alt="Current Image" style="max-width: 200px; max-height: 200px;">
                        </div>
                    {% elif post_id and not current_image_url and form.image.data is none %}
                         <p class="mt-2 text-muted">업로드된 이미지가 없습니다.</p>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.video_embed_url.label(class="form-label") }}
                    {{ form.video_embed_url(class="form-control" + (" is-invalid" if form.video_embed_url.errors else ""), placeholder="예: https://www.youtube.com/watch?v=VIDEO_ID") }}
                    {% if form.video_embed_url.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.video_embed_url.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                {{ form.alt_text.label(class="form-label") }}
                {{ form.alt_text(class="form-control" + (" is-invalid" if form.alt_text.errors else ""), placeholder="이미지에 대한 설명을 입력하세요 (검색 엔진 및 접근성용)") }}
                {% if form.alt_text.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.alt_text.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.tags.label(class="form-label") }}
                {{ form.tags(class="form-control" + (" is-invalid" if form.tags.errors else ""), placeholder="예: python, flask, webdev") }}
                <div class="form-text">쉼표(,)로 태그를 구분해주세요.</div>
                {% if form.tags.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.tags.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="d-flex justify-content-end">
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary me-2">취소</a>
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Make the admin token available to JavaScript
    const ADMIN_TOKEN = "{{ admin_token | default('') }}";

    document.addEventListener('DOMContentLoaded', function(){
        const contentElement = document.getElementById('content');
        const autosaveKey = contentElement.dataset.autosaveKey;    
        tinymce.init({
            selector: '#content',
            skin: 'oxide-dark', // Modern dark skin for the UI
            content_css: 'dark', // Dark theme for the content area
            ui_mode: 'split', // Separates menubar and toolbar
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            menubar: 'file edit view insert format tools table help',
            toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media link anchor codesample | ltr rtl',
            toolbar_sticky: true,
            autosave_ask_before_unload: true,
            autosave_interval: '30s',
            autosave_prefix: 'tinymce-autosave-' + autosaveKey + '-',
            autosave_restore_when_empty: false,
            autosave_retention: '2m',
            image_advtab: true,
            height: 600,
            image_caption: true,
            quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
            noneditable_class: 'mceNonEditable',
            toolbar_mode: 'sliding',
            contextmenu: 'link image table',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }',
            
            // Image Upload Configuration
            images_upload_url: '{{ url_for("admin.upload_editor_image") }}', // We'll use images_upload_handler to add token
            automatic_uploads: false, // We trigger upload manually in handler or let the handler do it

            images_upload_handler: function (blobInfo, success, failure, progress) {
                var xhr, formData;

                xhr = new XMLHttpRequest();
                xhr.withCredentials = false; // Important if you're not using cookies for auth
                xhr.open('POST', '{{ url_for("admin.upload_editor_image") }}');
                
                var token = ADMIN_TOKEN;
                if (!token) {
                    failure('인증 토큰을 찾을 수 없습니다. 다시 로그인해주세요.');
                    return;
                }
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                // Do not set Content-Type for FormData, browser will do it with boundary

                xhr.upload.onprogress = function (e) {
                    progress(e.loaded / e.total * 100);
                };

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        try {
                            json = JSON.parse(xhr.responseText);
                            failure('HTTP Error: ' + xhr.status + ' - ' + (json && json.error && json.error.message ? json.error.message : 'Unknown error'));
                        } catch (e) {
                            failure('HTTP Error: ' + xhr.status + '. Invalid JSON response: ' + xhr.responseText);
                        }
                        return;
                    }

                    json = JSON.parse(xhr.responseText);

                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }

                    success(json.location);
                };

                xhr.onerror = function () {
                    failure('Image upload failed due to a network error or server error. Status: ' + xhr.status);
                };

                formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                xhr.send(formData);
            }
        });
    });
</script>
{% endblock %}
