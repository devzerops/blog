{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block main_container_class %}container-fluid{% endblock %}

{% block head_extra %}
    <!-- 인증 토큰과 CSRF 토큰을 전역 변수로 정의 -->
    <script>
        // 인증 토큰과 CSRF 토큰을 전역변수로 정의
        window.ADMIN_TOKEN = "{{ session.get('admin_token', '') }}";
        window.CSRF_TOKEN = "{{ csrf_token() }}";
        console.log('토큰 상태:', window.ADMIN_TOKEN ? '토큰 있음' : '토큰 없음');
        console.log('CSRF 토큰 상태:', window.CSRF_TOKEN ? 'CSRF 토큰 있음' : 'CSRF 토큰 없음');
    </script>
    
    <!-- CKEditor 5 - 더 많은 기능이 포함된 Balloon 빌드 사용 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/balloon-block/ckeditor.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/balloon-block/translations/ko.js"></script>
    
    <!-- CKEditor 이미지 업로드 어댑터 -->
    <script>
        
        class CustomUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file.then(file => {
                    return new Promise((resolve, reject) => {
                        const data = new FormData();
                        data.append('file', file);
                        
                        // CSRF 토큰 추가 - Flask-WTF CSRF 보호를 위해 필수
                        if (window.CSRF_TOKEN) {
                            data.append('csrf_token', window.CSRF_TOKEN);
                            console.log('CSRF 토큰이 요청에 추가됨');
                        }

                        // 서버에 요청 보내기
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', '{{ url_for("admin.upload_editor_image") }}');
                        
                        // 인증 토큰 추가 - 전역변수 window.ADMIN_TOKEN 사용
                        if (window.ADMIN_TOKEN) {
                            xhr.setRequestHeader('Authorization', 'Bearer ' + window.ADMIN_TOKEN);
                            console.log('인증 토큰 전송 완료');
                        } else {
                            console.error('인증 토큰이 없습니다.');
                            reject('인증 토큰이 없습니다. 로그아웃 되었을 수 있으니 다시 로그인해주세요.');
                            return;
                        }
                        
                        // 응답 처리
                        xhr.onload = () => {
                            console.log('서버 응답:', xhr.status, xhr.responseText);
                            if (xhr.status >= 200 && xhr.status < 300) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    if (response && response.location) {
                                        resolve({ default: response.location });
                                    } else {
                                        reject('유효한 이미지 URL이 없습니다: ' + xhr.responseText);
                                    }
                                } catch (e) {
                                    reject('서버 응답을 처리하는 중 오류 발생: ' + e.message);
                                }
                            } else {
                                reject('업로드 실패. 서버 상태: ' + xhr.status + ', 응답: ' + xhr.responseText);
                            }
                        };
                        
                        // 오류 처리
                        xhr.onerror = () => {
                            console.error('네트워크 오류 발생');
                            reject('네트워크 오류로 업로드 실패');
                        };
                        
                        // 요청 전송
                        xhr.send(data);
                    });
                });
            }

            abort() {
                // 업로드 취소 로직 (필요시 구현)
            }
        }

        function CustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new CustomUploadAdapter(loader);
            };
        }
    </script>
    <style>
        /* CKEditor 스타일 */
        .ck-editor__editable {
            min-height: 750px;
            max-height: 750px;
            overflow-y: auto;
        }
        
        /* 이미지 업로드 영역 스타일 */
        .ck-file-dialog-button {
            display: block;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8 col-md-7">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>{{ title }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="글 제목") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control d-none" + (" is-invalid" if form.content.errors else ""), rows=25, placeholder="내용을 입력하세요...", id="content", **{'data-autosave-key': (post_id if post_id else 'new')}) }}
                            <div id="editor">{{ form.content.data|safe if form.content.data else '' }}</div>
                            {% if form.content.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.content.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4 col-md-5">
                <div class="card sticky-top" style="top: 20px;"> 
                    <div class="card-header">
                        <h4>Publishing Options</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if current_image_url %}
                                <div class="mt-2">
                                    <p class="mb-1"><small>Current Image:</small></p>
                                    <img src="{{ current_image_url }}" alt="Current Image" class="img-fluid rounded" style="max-height: 150px;">
                                </div>
                            {% elif post_id and not current_image_url and form.image.data is none %}
                                 <p class="mt-2 text-muted"><small>No image uploaded.</small></p>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.alt_text.label(class="form-label") }}
                            {{ form.alt_text(class="form-control" + (" is-invalid" if form.alt_text.errors else ""), placeholder="Image alt text") }}
                            {% if form.alt_text.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.alt_text.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.video_embed_url.label(class="form-label") }}
                            {{ form.video_embed_url(class="form-control" + (" is-invalid" if form.video_embed_url.errors else ""), placeholder="e.g., YouTube URL") }}
                            {% if form.video_embed_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.video_embed_url.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select") }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.category.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-control" + (" is-invalid" if form.tags.errors else ""), placeholder="tag1, tag2, tag3") }}
                            {% if form.tags.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tags.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" name="save_draft" value="true" class="btn btn-info me-md-2">Save Draft</button>
                            <button type="submit" name="publish" value="true" class="btn btn-primary">{{ 'Publish' if not post else 'Update Post' }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // 전역 변수로 정의된 window.ADMIN_TOKEN 사용

    document.addEventListener('DOMContentLoaded', function() {
        const contentElement = document.getElementById('content');
        const autosaveKey = contentElement.dataset.autosaveKey;

        // CKEditor Balloon-Block 초기화
        BalloonEditor
            .create(document.querySelector('#editor'), {
                placeholder: '내용을 입력하세요...',
                language: 'ko',
                // 커스텀 업로드 어댑터 플러그인 사용
                extraPlugins: [ CustomUploadAdapterPlugin ],
                // 블록 툴바 - 사용 가능한 아이템만 포함
                blockToolbar: [
                    'heading', '|',
                    'bulletedList', 'numberedList', '|',
                    'insertTable', 'imageUpload', 'blockQuote', '|',
                    'undo', 'redo'
                ],
                // 벌룬 툴바
                balloonToolbar: [
                    'bold', 'italic', 'link', 'imageUpload'
                ],
                // 이미지 업로드 구성
                image: {
                    toolbar: [
                        'imageTextAlternative', 'toggleImageCaption',
                        'imageStyle:inline', 'imageStyle:block', 'imageStyle:side'
                    ],
                    styles: [
                        'full', 'alignLeft', 'alignRight'
                    ],
                    resizeOptions: [
                        {
                            name: 'resizeImage:original',
                            label: '원본 크기',
                            value: null
                        },
                        {
                            name: 'resizeImage:50',
                            label: '50%',
                            value: '50'
                        },
                        {
                            name: 'resizeImage:75',
                            label: '75%',
                            value: '75'
                        }
                    ]
                }
            })
            .then(editor => {
                // 에디터 인스턴스 저장
                window.editor = editor;
                
                // 폼 제출 시 hidden input에 내용 저장
                document.querySelector('form').addEventListener('submit', function(e) {
                    document.getElementById('content').value = editor.getData();
                });
                
                // 이제 simpleUpload 플러그인을 통해 이미지 업로드가 자동으로 처리됨
                console.log('이미지 업로드 기능 준비 완료');
                
                // 자동 저장 기능 구현
                const saveData = () => {
                    const data = editor.getData();
                    localStorage.setItem('ckeditor-autosave-' + autosaveKey, data);
                };
                
                // 30초마다 자동 저장
                const autosaveInterval = setInterval(saveData, 30000);
                
                // 페이지 언로드 시 자동 저장 중지
                window.addEventListener('beforeunload', () => {
                    clearInterval(autosaveInterval);
                    saveData(); // 페이지 나가기 전 마지막 저장
                });
                
                // 자동 저장된 내용 복원
                const savedData = localStorage.getItem('ckeditor-autosave-' + autosaveKey);
                if (savedData && !editor.getData()) {
                    editor.setData(savedData);
                }
                
                console.log('CKEditor 초기화 완료');
            })
            .catch(error => {
                console.error('CKEditor 초기화 오류:', error);
            });
    });
</script>
{% endblock %}
