{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block main_container_class %}container-fluid{% endblock %}

{% block head_extra %}
    <!-- 인증 토큰과 CSRF 토큰을 전역 변수로 정의 -->
    <script>
        // 인증 토큰과 CSRF 토큰을 전역변수로 정의
        window.ADMIN_TOKEN = "{{ session.get('admin_token', '') }}";
        window.CSRF_TOKEN = "{{ csrf_token() }}";
        console.log('토큰 상태:', window.ADMIN_TOKEN ? '토큰 있음' : '토큰 없음');
        console.log('CSRF 토큰 상태:', window.CSRF_TOKEN ? 'CSRF 토큰 있음' : 'CSRF 토큰 없음');
    </script>
    
    <!-- CKEditor 5 - Classic 빌드 사용 (이미지 드래그 조절 지원) -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/translations/ko.js"></script>
    <!-- 이미지 레이아웃 스타일 추가 -->
    <style>
        /* 이미지 스타일 - 왼쪽 정렬 */
        .image-style-align-left {
            float: left;
            margin-right: 20px;
        }
        
        /* 이미지 스타일 - 오른쪽 정렬 */
        .image-style-align-right {
            float: right;
            margin-left: 20px;
        }
        
        /* 이미지 스타일 - 가운데 정렬 */
        .image-style-align-center {
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
        
        /* 이미지 캡션 스타일 */
        .image figcaption {
            text-align: center;
            font-style: italic;
            font-size: 0.9em;
            color: #666;
        }
    </style>
    
    <!-- CKEditor 이미지 업로드 어댑터 - Classic 빌드용 -->
    <script>
        // 커스텀 업로드 어댑터 클래스
        class MyUploadAdapter {
            constructor(loader) {
                // CKEditor 5 파일 로더 인스턴스
                this.loader = loader;
            }

            // 업로드 시작
            upload() {
                return this.loader.file
                    .then(file => {
                        return new Promise((resolve, reject) => {
                            const data = new FormData();
                            data.append('file', file);
                            
                            // CSRF 토큰 추가
                            if (window.CSRF_TOKEN) {
                                data.append('csrf_token', window.CSRF_TOKEN);
                                console.log('CSRF 토큰이 요청에 추가됨');
                            }

                            // XMLHttpRequest 사용
                            const xhr = new XMLHttpRequest();
                            xhr.open('POST', '{{ url_for("admin.upload_editor_image") }}');
                            
                            // 인증 토큰 추가
                            if (window.ADMIN_TOKEN) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + window.ADMIN_TOKEN);
                                console.log('인증 토큰 전송 완료');
                            } else {
                                console.error('인증 토큰이 없습니다.');
                                reject('인증 토큰이 없습니다. 로그아웃 되었을 수 있으니 다시 로그인해주세요.');
                                return;
                            }
                            
                            // 요청 완료시 처리
                            xhr.onload = () => {
                                console.log('서버 응답:', xhr.status, xhr.responseText);
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    try {
                                        const response = JSON.parse(xhr.responseText);
                                        // 성공적으로 이미지 URL을 받으면 resolve
                                        if (response && response.location) {
                                            resolve({ default: response.location });
                                        } else {
                                            reject('유효한 이미지 URL이 없습니다.');
                                        }
                                    } catch (e) {
                                        reject('서버 응답을 처리하는 중 오류 발생: ' + e.message);
                                    }
                                } else {
                                    reject('업로드 실패. 서버 상태: ' + xhr.status + ', 응답: ' + xhr.responseText);
                                }
                            };
                            
                            // 오류 처리
                            xhr.onerror = () => {
                                reject('네트워크 오류로 업로드 실패');
                            };
                            
                            // 업로드 진행상황 모니터링
                            xhr.upload.onprogress = evt => {
                                if (evt.lengthComputable) {
                                    this.loader.uploadTotal = evt.total;
                                    this.loader.uploaded = evt.loaded;
                                }
                            };
                            
                            // 요청 전송
                            xhr.send(data);
                        });
                    });
            }

            // 업로드 취소
            abort() {
                // 취소 로직 구현 (필요시)
            }
        }

        // 업로드 어댑터 플러그인 함수
        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new MyUploadAdapter(loader);
            };
        }
    </script>
    <style>
        /* CKEditor 스타일 */
        .ck-editor__editable {
            min-height: 750px;
            max-height: 750px;
            overflow-y: auto;
        }
        
        /* 이미지 업로드 영역 스타일 */
        .ck-file-dialog-button {
            display: block;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8 col-md-7">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>{{ title }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="글 제목") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control d-none" + (" is-invalid" if form.content.errors else ""), rows=25, placeholder="내용을 입력하세요...", id="content", **{'data-autosave-key': (post_id if post_id else 'new')}) }}
                            <div id="editor">{{ form.content.data|safe if form.content.data else '' }}</div>
                            {% if form.content.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.content.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4 col-md-5">
                <div class="card sticky-top" style="top: 20px;"> 
                    <div class="card-header">
                        <h4>Publishing Options</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if current_image_url %}
                                <div class="mt-2">
                                    <p class="mb-1"><small>Current Image:</small></p>
                                    <img src="{{ current_image_url }}" alt="Current Image" class="img-fluid rounded" style="max-height: 150px;">
                                </div>
                            {% elif post_id and not current_image_url and form.image.data is none %}
                                 <p class="mt-2 text-muted"><small>No image uploaded.</small></p>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.alt_text.label(class="form-label") }}
                            {{ form.alt_text(class="form-control" + (" is-invalid" if form.alt_text.errors else ""), placeholder="Image alt text") }}
                            {% if form.alt_text.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.alt_text.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.video_embed_url.label(class="form-label") }}
                            {{ form.video_embed_url(class="form-control" + (" is-invalid" if form.video_embed_url.errors else ""), placeholder="e.g., YouTube URL") }}
                            {% if form.video_embed_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.video_embed_url.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select") }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.category.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            <div class="tag-input-container">
                                <div class="tags-container form-control d-flex flex-wrap gap-1 p-1" id="tags-display">
                                    <!-- Tags will be displayed here -->
                                    <input type="text" id="tag-input" class="tag-input flex-grow-1 border-0" placeholder="입력 후 Tab키 누르면 태그 추가" style="outline: none; min-width: 100px;">
                                </div>
                                {{ form.tags(class="d-none" + (" is-invalid" if form.tags.errors else ""), id="actual-tags-input") }}
                                <small class="form-text text-muted">태그를 입력하고 Tab 키를 누르면 태그가 추가됩니다.</small>
                            </div>
                            {% if form.tags.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tags.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- 태그 입력을 위한 CSS 스타일 -->
                        <style>
                            .tag-item {
                                background-color: #375a7f; /* 어두운 테마에 맞는 태그 배경색 */
                                color: #fff; /* 태그 텍스트 색상 */
                                border-radius: 4px;
                                padding: 3px 10px;
                                margin-right: 5px;
                                margin-bottom: 5px;
                                display: inline-flex;
                                align-items: center;
                            }
                            .tag-remove {
                                margin-left: 8px;
                                cursor: pointer;
                                font-weight: bold;
                                color: #adb5bd; /* 삭제 버튼 색상 */
                            }
                            .tag-remove:hover {
                                color: #fff; /* 호버 시 삭제 버튼 색상 */
                            }
                            .tag-input {
                                background: transparent;
                                color: #fff; /* 입력창 텍스트 색상 */
                            }
                            .tags-container {
                                background-color: #222; /* 태그 컨테이너 배경색 */
                                border-color: #444;
                                color: #fff;
                            }
                            .tags-container:focus-within {
                                border-color: #375a7f; /* 포커스 시 테두리 색상 */
                                outline: 0;
                                box-shadow: 0 0 0 0.25rem rgba(55, 90, 127, 0.25);
                            }
                        </style>
                    </div>
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" name="save_draft" value="true" class="btn btn-info me-md-2">Save Draft</button>
                            <button type="submit" name="publish" value="true" class="btn btn-primary">{{ 'Publish' if not post else 'Update Post' }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // 태그 입력 처리 스크립트
    document.addEventListener('DOMContentLoaded', function() {
        const tagInput = document.getElementById('tag-input');
        const tagsContainer = document.getElementById('tags-display');
        const actualTagsInput = document.getElementById('actual-tags-input');
        
        // 기존 태그가 있으면 로드
        loadExistingTags();
        
        // Tab 키를 사용해 태그 추가 처리
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault(); // 기본 Tab 동작 차단
                addTag();
            } else if (e.key === 'Enter') {
                // Enter 키도 태그 추가로 처리하지만 폼 제출은 방지
                e.preventDefault();
                addTag();
            } else if (e.key === 'Backspace' && tagInput.value === '') {
                // 입력창이 비어있고 Backspace를 누르면 마지막 태그 삭제
                const tags = tagsContainer.querySelectorAll('.tag-item');
                if (tags.length > 0) {
                    removeTag(tags[tags.length - 1]);
                }
            }
        });
        
        // 태그 추가 함수
        function addTag() {
            const tagValue = tagInput.value.trim();
            if (tagValue) {
                createTagElement(tagValue);
                tagInput.value = '';
                updateActualInput();
            }
        }
        
        // 태그 삭제 함수
        function removeTag(tagElement) {
            tagsContainer.removeChild(tagElement);
            updateActualInput();
        }
        
        // 태그 요소 생성 함수
        function createTagElement(tagText) {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag-item';
            tagElement.innerHTML = `
                ${tagText}
                <span class="tag-remove">&times;</span>
            `;
            
            // 삭제 버튼 이벤트 추가
            const removeButton = tagElement.querySelector('.tag-remove');
            removeButton.addEventListener('click', function() {
                removeTag(tagElement);
            });
            
            // 태그 입력 필드 앞에 태그 추가
            tagsContainer.insertBefore(tagElement, tagInput);
        }
        
        // 실제 폼 입력값 업데이트
        function updateActualInput() {
            const tags = [];
            tagsContainer.querySelectorAll('.tag-item').forEach(function(tag) {
                const tagText = tag.textContent.trim().replace('×', '').trim();
                if (tagText) tags.push(tagText);
            });
            
            // 콌마로 구분된 텍스트 형태로 저장 (백엔드 호환성)
            actualTagsInput.value = tags.join(', ');
            console.log('태그 업데이트:', actualTagsInput.value);
        }
        
        // 기존 태그 로드 함수
        function loadExistingTags() {
            if (actualTagsInput.value) {
                const existingTags = actualTagsInput.value.split(',').map(tag => tag.trim());
                existingTags.forEach(tag => {
                    if (tag) createTagElement(tag);
                });
            }
        }
    });
    
    // 전역 변수로 정의된 window.ADMIN_TOKEN 사용

    document.addEventListener('DOMContentLoaded', function() {
        const contentElement = document.getElementById('content');
        const autosaveKey = contentElement.dataset.autosaveKey;

        // CKEditor Classic 초기화 - 이미지 크기 조절 기능 포함
        ClassicEditor
            .create(document.querySelector('#editor'), {
                placeholder: '내용을 입력하세요...',
                language: 'ko',
                // 커스텀 업로드 어댑터 사용
                extraPlugins: [MyCustomUploadAdapterPlugin],
                // 툴바 구성
                toolbar: {
                    items: [
                        'heading',
                        '|',
                        'bold',
                        'italic',
                        'link',
                        'bulletedList',
                        'numberedList',
                        '|',
                        'insertTable',
                        'uploadImage',
                        'blockQuote',
                        '|',
                        'undo',
                        'redo'
                    ]
                },
                // 이미지 관련 설정
                image: {
                    // 이미지 스타일 설정
                    styles: [
                        'alignLeft', 'alignCenter', 'alignRight'
                    ],
                    // 이미지 툴바 구성
                    toolbar: [
                        'imageStyle:alignLeft', 'imageStyle:alignCenter', 'imageStyle:alignRight',
                        '|',
                        'imageTextAlternative',
                        '|',
                        'toggleImageCaption'
                    ],
                    // 이미지 드래그로 크기 조절 활성화
                    resizeOptions: {
                        buttons: true,  // 크기 조절 버튼 표시
                        ui: true        // 드래그 허용
                    }
                },
                // 테이블 구성
                table: {
                    contentToolbar: [
                        'tableColumn',
                        'tableRow',
                        'mergeTableCells'
                    ]
                }
            })
            .then(editor => {
                // 에디터 인스턴스 저장
                window.editor = editor;
                
                console.log('CKEditor 초기화 완료');
                
                // 폼 제출 시 hidden input에 내용 저장 (완전히 개선된 버전)
                const form = document.querySelector('form');
                const contentField = document.getElementById('content');
                
                // 폼 제출을 위한 함수
                function submitPostForm(buttonName, buttonValue) {
                    try {
                        // 에디터 내용 가져오기
                        const editorContent = editor.getData();
                        
                        // 디버깅용 로그
                        console.log('에디터 내용 길이:', editorContent.length);
                        
                        if (editorContent.trim().length === 0) {
                            alert('내용을 입력해주세요.');
                            return false;
                        }
                        
                        // 폼 새로 만들기
                        const newForm = document.createElement('form');
                        newForm.method = 'POST';
                        newForm.action = window.location.href;
                        newForm.enctype = 'multipart/form-data';
                        
                        // CSRF 토큰 추가
                        const csrfField = document.querySelector('input[name="csrf_token"]');
                        if (csrfField) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = 'csrf_token';
                            csrfInput.value = csrfField.value;
                            newForm.appendChild(csrfInput);
                        }
                        
                        // 제목 추가
                        const titleField = document.querySelector('input[name="title"]');
                        if (titleField) {
                            const titleInput = document.createElement('input');
                            titleInput.type = 'hidden';
                            titleInput.name = 'title';
                            titleInput.value = titleField.value;
                            newForm.appendChild(titleInput);
                        }
                        
                        // 내용 추가 (에디터에서 가져온 내용)
                        const contentInput = document.createElement('input');
                        contentInput.type = 'hidden';
                        contentInput.name = 'content';
                        contentInput.value = editorContent;
                        newForm.appendChild(contentInput);
                        
                        // 버튼 정보 추가
                        const buttonInput = document.createElement('input');
                        buttonInput.type = 'hidden';
                        buttonInput.name = buttonName;
                        buttonInput.value = buttonValue || 'true';
                        newForm.appendChild(buttonInput);
                        
                        // 카테고리 선택 값 추가 - 이 부분이 중요함
                        const categoryField = document.querySelector('select[name="category"]');
                        if (categoryField) {
                            console.log('카테고리 값:', categoryField.value);
                            const categoryInput = document.createElement('input');
                            categoryInput.type = 'hidden';
                            categoryInput.name = 'category';
                            categoryInput.value = categoryField.value;
                            newForm.appendChild(categoryInput);
                        }
                        
                        // 그 외 필요한 필드들 추가
                        const otherFields = form.querySelectorAll('input:not([type="submit"]), textarea');
                        otherFields.forEach(field => {
                            if (field.name && field.name !== 'content' && field.name !== 'title' && field.name !== 'csrf_token' && field.name !== 'category') {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = field.name;
                                input.value = field.value;
                                newForm.appendChild(input);
                            }
                        });
                        
                        // 폼을 동적으로 생성하고 제출
                        document.body.appendChild(newForm);
                        console.log('새 폼 제출 준비 완료');
                        newForm.submit();
                        console.log('폼 제출됨');
                        return true;
                    } catch (error) {
                        console.error('폼 제출 중 오류 발생:', error);
                        alert('게시글 저장 중 오류가 발생했습니다: ' + error.message);
                        return false;
                    }
                }
                
                // 제출 버튼에 클릭 이벤트 리스너 추가
                document.querySelectorAll('button[type="submit"]').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        submitPostForm(this.name, this.value);
                    });
                });
                
                // 기존 폼 제출 이벤트는 무시
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('기존 폼 제출 차단됨');
                });
                
                // 자동 저장 기능 추가
                
                // 이제 simpleUpload 플러그인을 통해 이미지 업로드가 자동으로 처리됨
                console.log('이미지 업로드 기능 준비 완료');
                
                // 자동 저장 기능 구현
                const saveData = () => {
                    const data = editor.getData();
                    localStorage.setItem('ckeditor-autosave-' + autosaveKey, data);
                };
                
                // 30초마다 자동 저장
                const autosaveInterval = setInterval(saveData, 30000);
                
                // 페이지 언로드 시 자동 저장 중지
                window.addEventListener('beforeunload', () => {
                    clearInterval(autosaveInterval);
                    saveData(); // 페이지 나가기 전 마지막 저장
                });
                
                // 자동 저장된 내용 복원
                const savedData = localStorage.getItem('ckeditor-autosave-' + autosaveKey);
                if (savedData && !editor.getData()) {
                    editor.setData(savedData);
                }
                
                console.log('CKEditor 초기화 완료');
            })
            .catch(error => {
                console.error('CKEditor 초기화 오류:', error);
            });
    });
</script>
{% endblock %}
