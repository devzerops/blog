{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block main_container_class %}container-fluid{% endblock %}

{% block head_extra %}
    <!-- TinyMCE -->
    <script src="{{ url_for('static', filename='tinymce/tinymce.min.js') }}" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8 col-md-7">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>{{ title }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="글 제목") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control" + (" is-invalid" if form.content.errors else ""), rows=25, placeholder="Markdown 형식으로 내용을 입력하세요...", id="content", **{'data-autosave-key': (post_id if post_id else 'new')}) }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.content.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4 col-md-5">
                <div class="card sticky-top" style="top: 20px;"> 
                    <div class="card-header">
                        <h4>Publishing Options</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if current_image_url %}
                                <div class="mt-2">
                                    <p class="mb-1"><small>Current Image:</small></p>
                                    <img src="{{ current_image_url }}" alt="Current Image" class="img-fluid rounded" style="max-height: 150px;">
                                </div>
                            {% elif post_id and not current_image_url and form.image.data is none %}
                                 <p class="mt-2 text-muted"><small>No image uploaded.</small></p>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.alt_text.label(class="form-label") }}
                            {{ form.alt_text(class="form-control" + (" is-invalid" if form.alt_text.errors else ""), placeholder="Image alt text") }}
                            {% if form.alt_text.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.alt_text.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.video_embed_url.label(class="form-label") }}
                            {{ form.video_embed_url(class="form-control" + (" is-invalid" if form.video_embed_url.errors else ""), placeholder="e.g., YouTube URL") }}
                            {% if form.video_embed_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.video_embed_url.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-control" + (" is-invalid" if form.tags.errors else ""), placeholder="tag1, tag2, tag3") }}
                            {% if form.tags.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tags.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" name="save_draft" value="true" class="btn btn-info me-md-2">Save Draft</button>
                            <button type="submit" name="publish" value="true" class="btn btn-primary">Publish</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Make the admin token available to JavaScript
    const ADMIN_TOKEN = "{{ admin_token | default('') }}";

    document.addEventListener('DOMContentLoaded', function(){
        const contentElement = document.getElementById('content');
        const autosaveKey = contentElement.dataset.autosaveKey;    
        tinymce.init({
            selector: '#content',
            skin: 'oxide-dark', // Modern dark skin for the UI
            content_css: 'dark', // Dark theme for the content area
            ui_mode: 'split', // Separates menubar and toolbar
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            menubar: 'file edit view insert format tools table help',
            toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media link anchor codesample | ltr rtl',
            toolbar_sticky: true,
            autosave_ask_before_unload: true,
            autosave_interval: '30s',
            autosave_prefix: 'tinymce-autosave-' + autosaveKey + '-',
            autosave_restore_when_empty: false,
            autosave_retention: '2m',
            image_advtab: true,
            height: 750,
            image_caption: true,
            quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
            noneditable_class: 'mceNonEditable',
            toolbar_mode: 'sliding',
            contextmenu: 'link image table',
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }',
            
            // Image Upload Configuration
            images_upload_url: '{{ url_for("admin.upload_editor_image") }}', // We'll use images_upload_handler to add token
            automatic_uploads: false, // We trigger upload manually in handler or let the handler do it

            images_upload_handler: function (blobInfo, success, failure, progress) {
                var xhr, formData;

                xhr = new XMLHttpRequest();
                xhr.withCredentials = false; // Important if you're not using cookies for auth
                xhr.open('POST', '{{ url_for("admin.upload_editor_image") }}');
                
                var token = ADMIN_TOKEN;
                if (!token) {
                    failure('인증 토큰을 찾을 수 없습니다. 다시 로그인해주세요.');
                    return;
                }
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                // Do not set Content-Type for FormData, browser will do it with boundary

                xhr.upload.onprogress = function (e) {
                    progress(e.loaded / e.total * 100);
                };

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        try {
                            json = JSON.parse(xhr.responseText);
                            failure('HTTP Error: ' + xhr.status + ' - ' + (json && json.error && json.error.message ? json.error.message : 'Unknown error'));
                        } catch (e) {
                            failure('HTTP Error: ' + xhr.status + '. Invalid JSON response: ' + xhr.responseText);
                        }
                        return;
                    }

                    json = JSON.parse(xhr.responseText);

                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }

                    success(json.location);
                };

                xhr.onerror = function () {
                    failure('Image upload failed due to a network error or server error. Status: ' + xhr.status);
                };

                formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                xhr.send(formData);
            }
        });
    });
</script>
{% endblock %}
